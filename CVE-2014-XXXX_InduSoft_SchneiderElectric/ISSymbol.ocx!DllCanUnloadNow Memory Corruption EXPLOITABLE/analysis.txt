Description: User Mode Write AV
Short Description: WriteAV
Exploitability Classification: EXPLOITABLE
Recommended Bug Title: Exploitable - User Mode Write AV starting at ISSymbol!DllCanUnloadNow+0x0000000000078f4d (Hash=0x11f3963d.0x94308082)

*** Product version

Indusoft 7.1 SP2 Patch 4
See also screenshots in attachment

*** Trigger

0. The malformed file is Project/Screen/home.scr -- see original home.scr.orig in the same directory.

1. Open the crafted .app file (Indusoft Project) in Indusoft Viewer (can be done from the Indusoft Web Studio -> click 'Run project')
2. Click few error Message Box'es 
3. Finally, click on the 'Alarms' button in the lower down corner of the screen.

Actually, the vulnerability is triggered immediately after step 2, which generates the 1st chance exception due to corrupted memory execution. But step 3 is necessary to take only when the program is not being debugged.

*** Analysis

FAULTING_IP: 
ISSymbol!DllCanUnloadNow+78f4d
103ce470 0000            add     byte ptr [eax],al
â€¦

The following memory was executed at EIP when it hit the 1st chance exception:

ISSymbol!DllCanUnloadNow+0x78f4d:
103ce470 0000            add     byte ptr [eax],al
103ce472 0000            add     byte ptr [eax],al
103ce474 0000            add     byte ptr [eax],al
103ce476 0000            add     byte ptr [eax],al
103ce478 0000            add     byte ptr [eax],al
103ce47a 0000            add     byte ptr [eax],al
103ce47c e0dc            loopne  ISSymbol!DllCanUnloadNow+0x78f37 (103ce45a)
103ce47e 40              inc     eax

The control transfer to the corrupted memory offset was done from here:

ISSymbol!DllUnregisterServer+0x264b61:
--> starts calculation of call eax: 
1026e9c1 89854cffffff    mov     dword ptr [ebp-0B4h],eax
1026e9c7 8b8d4cffffff    mov     ecx,dword ptr [ebp-0B4h]
1026e9cd 8b5104          mov     edx,dword ptr [ecx+4]
1026e9d0 8995b8feffff    mov     dword ptr [ebp-148h],edx
1026e9d6 8b85b8feffff    mov     eax,dword ptr [ebp-148h]
1026e9dc 8b10            mov     edx,dword ptr [eax]
1026e9de 8b8db8feffff    mov     ecx,dword ptr [ebp-148h]
1026e9e4 8b8284010000    mov     eax,dword ptr [edx+184h]
--> 1026e9ea ffd0            call    eax <-- go to vuln

The eax was calculated as follows:

ISSymbol!DllUnregisterServer+0x264b61:
1026e9c1 89854cffffff    mov     dword ptr [ebp-0B4h],eax
1026e9c7 8b8d4cffffff    mov     ecx,dword ptr [ebp-0B4h]
1026e9cd 8b5104          mov     edx,dword ptr [ecx+4]
1026e9d0 8995b8feffff    mov     dword ptr [ebp-148h],edx
1026e9d6 8b85b8feffff    mov     eax,dword ptr [ebp-148h]
1026e9dc 8b10            mov     edx,dword ptr [eax]
1026e9de 8b8db8feffff    mov     ecx,dword ptr [ebp-148h]
--> 1026e9e4 8b8284010000    mov     eax,dword ptr [edx+184h] <-- wrong address at [edx+184] 
1026e9ea ffd0            call    eax